<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<link rel="shortcut icon" href="#" />
<script src="/javascripts/vue.js"></script>
<script src="/javascripts/jquery-3.2.1.min.js"></script>
<link rel="stylesheet" href="/stylesheets/apitool.css">
<link rel="stylesheet" href="/stylesheets/marked.css">
<script src="/javascripts/marked.min.js"></script>
<title></title>
<script type="text/javascript">
</script>
</head>
<body>
<div id="apitool">
  <!-- 头部组件 -->
  <header-comp></header-comp>
  <!-- //头部组件 -->
  <!-- 工具栏 -->
  <div class="toolbar">
    <div class="tb-left">
      <div class="tb-format">
        <ul>
          <li v-for="(item, index) in formats" @click="formatApply(item.name, index)">
            <i :class="['ad-format-' + item.name, item.isActive ? 'active' : '']" ></i>
          </li>
        </ul>
      </div>
    </div>
    <div class="tb-right">
      <a href="javascript:;" class="publish" @click="publish">发布</a>
    </div>
  </div>
  <!-- //工具栏 -->

  <!-- 编辑区 -->
  <div class="ad-container">
    <!-- 标题 -->
    <div class="ad-title">
      <input  name="title" v-model="title" type="text"  placeholder="">
    </div>
    <!-- //标题 -->
    <div class="ad-article">
      <div class="article-origin">
        <textarea name="content" ref="txta" v-model="content"  class="art-area" placeholder="" @click="clickText"  @input="autoHeight" @select="selectText"></textarea>
      </div>
      <div class="article-marked">
        <!-- marked -->
        <div class="marked-parse" id="marked-content" v-html="markedContent">

        </div>
        <!-- //marked -->
     </div>
   </div>
  </div>
  <!-- //编辑区 -->
  <!-- 保存提示 -->
  <div class="ad-alert" v-if="success">
    <i class="iconfont icon-success"></i> {{ msg }}
  </div>
  <!-- //保存提示 -->
</div>

<script src="/javascripts/header.js"></script>
<script type="text/javascript">
// vue
var vm = new Vue({
  el: '#apitool',
  components: {
    headerComp: HeaderComp
  },
  data: {
    title: "文章标题",
    content: "[Markdown Editor]",
    msg: "",
    success: false,
    formats: [
      { name: "bold", isActive: false, character:"# " },
      { name: "italic", isActive: false, character:"_"  },
    ],
    selectedInfo: {
      val: "",
      startPos: 0,
      endPos: 0,
      selectedText: ""
    }
  },
  mounted:function() {
    var _this = this
    _this.$nextTick(function () {
      // textarea自适应高度初始化
      var sch = $(".art-area")[0].scrollHeight
      $(".art-area").css("height", (sch) + "px")
    })
  },
  computed:{
    markedContent:function(){
      return marked(this.content)
    }
  },
  methods:{
    //发布
    publish: function(){
      var _this = this
      $.ajax({
  			type: "post",
  			url: "./add",
        data:{
         title: this.title,
         content: this.content
        },
  			dataType: "json",
  			success: function(res){
          _this.msg = res.message
          _this.success = true
          setTimeout(function(){
            window.location.href = "/article/list_article.html"
          },1000)

  			}
  		})
    },
    // textarea高度自适应
    autoHeight: function(event) {
      var _this = this
      var $el = $(event.target)
      $el.css("height", "auto")
      $el.css("height", ($el[0].scrollHeight)+ "px")
    },
    // 选中的文字
    selectText: function(evnet){
      var el = event.target
      this.selectedInfo.val = el.value
      this.selectedInfo.startPos = el.selectionStart
      this.selectedInfo.endPos = el.selectionEnd
      this.selectedInfo.text = el.value.substring(el.selectionStart, el.selectionEnd)
      console.log("selected");
    },
    // 点击,没有选择文本
    clickText: function(evnet){
      var el = event.target
      el.focus(); 
      this.selectedInfo.endPos = this.selectedInfo.startPos = el.selectionStart
    },
    // 格式化文本-- 不需要保留状态
    formatApply: function(name, i){
      var el = $(".art-area")[0]
      el.focus();
      if ('selectionStart' in el) {
         if (this.selectedInfo.startPos != this.selectedInfo.endPos) {
           // 插入格式符
           switch(name) {
             // 粗体
             case "bold":
                 // 取消加粗
                 if(this.selectedInfo.val.substring(this.selectedInfo.startPos - 2, this.selectedInfo.startPos) == "**" && this.selectedInfo.val.substring(this.selectedInfo.endPos, this.selectedInfo.endPos + 2) == "**"){
                    this.content = this.selectedInfo.val.substring(0, this.selectedInfo.startPos - 2) + this.selectedInfo.text + this.selectedInfo.val.substring(this.selectedInfo.endPos + 2)
                    setTimeout(()=>{
                      el.selectionStart = this.selectedInfo.startPos - 2
                      el.selectionEnd = this.selectedInfo.endPos - 2
                    }, 10)
                 }else{
                 // 加粗
                    this.content = this.selectedInfo.val.substring(0, this.selectedInfo.startPos) + "**" + this.selectedInfo.text + "**" + this.selectedInfo.val.substring(this.selectedInfo.endPos)
                    setTimeout(()=>{
                      el.selectionStart = this.selectedInfo.startPos + 2
                      el.selectionEnd = this.selectedInfo.endPos + 2
                    }, 10)
                 }
               break
             // 斜体
             case "italic":
                 this.content = startText + "_" + selectedText + "_" + endText
                 setTimeout(function(){
                     el.selectionStart = startPos + 1;
                     el.selectionEnd = endPos + 1;
                 }, 10)
               break
           }
         }

      }
    },
  }
})
</script>

</body>
</html>
