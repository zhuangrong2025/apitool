<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<link rel="shortcut icon" href="#" />
<script src="/javascripts/vue.js"></script>
<script src="/javascripts/jquery-3.2.1.min.js"></script>
<link rel="stylesheet" href="/stylesheets/apitool.css">
<link rel="stylesheet" href="/stylesheets/marked.css">
<script src="/javascripts/marked.min.js"></script>
<title></title>
<script type="text/javascript">
</script>
</head>
<body>
<div id="apitool">
  <!-- 头部组件 -->
  <header-comp></header-comp>
  <!-- //头部组件 -->
  <!-- 工具栏 -->
  <div class="toolbar">
    <div class="tb-left">
      <div class="tb-format">
        <ul>
          <li v-for="(item, index) in formats" @click="formatApply(item.name, index)" @mousedown="formatPrevent">
            <i :class="['ad-format-' + item.name, item.isActive ? 'active' : '']" ></i>
          </li>
        </ul>
      </div>
    </div>
    <div class="tb-right">
      <a href="javascript:;" class="publish" @click="publish">发布</a>
    </div>
  </div>
  <!-- //工具栏 -->

  <!-- 编辑区 -->
  <div class="ad-container">
    <!-- 标题 -->
    <div class="ad-title">
      <input  name="title" v-model="title" type="text"  placeholder="">
    </div>
    <!-- //标题 -->
    <div class="ad-article">
      <div class="article-origin">
        <textarea name="content" ref="txta" v-model="content"  class="art-area" placeholder=""  @blur="blurText"  @input="autoHeight" ></textarea>
      </div>
      <div class="article-marked">
        <!-- marked -->
        <div class="marked-parse" id="marked-content" v-html="markedContent">

        </div>
        <!-- //marked -->
     </div>
   </div>
  </div>
  <!-- //编辑区 -->
  <!-- 保存提示 -->
  <div class="ad-alert" v-if="success">
    <i class="iconfont icon-success"></i> {{ msg }}
  </div>
  <!-- //保存提示 -->
</div>

<script src="/javascripts/header.js"></script>
<script type="text/javascript">
// vue
var vm = new Vue({
  el: '#apitool',
  components: {
    headerComp: HeaderComp
  },
  data: {
    title: "文章标题",
    content: "[Markdown Editor]",
    msg: "",
    success: false,
    formats: [
      { name: "bold", isActive: false, character:"# " },
      { name: "italic", isActive: false, character:"_"  },
    ],
    selectedInfo: {
      val: "",
      startPos: 0,
      endPos: 0,
      selectedText: ""
    }
  },
  mounted:function() {
    var _this = this
    _this.$nextTick(function () {
      // textarea自适应高度初始化
      var sch = $(".art-area")[0].scrollHeight
      $(".art-area").css("height", (sch) + "px")
    })
  },
  computed:{
    markedContent:function(){
      return marked(this.content)
    }
  },
  methods:{
    //发布
    publish: function(){
      var _this = this
      $.ajax({
  			type: "post",
  			url: "./add",
        data:{
         title: this.title,
         content: this.content
        },
  			dataType: "json",
  			success: function(res){
          _this.msg = res.message
          _this.success = true
          setTimeout(function(){
            window.location.href = "/article/list_article.html"
          },1000)

  			}
  		})
    },
    // textarea高度自适应
    autoHeight: function(event) {
      var _this = this
      var $el = $(event.target)
      $el.css("height", "auto")
      $el.css("height", ($el[0].scrollHeight)+ "px")
    },
    // 失去焦点
    blurText: function(evnet){
      var el = event.target
      el.selectionStart = el.selectionEnd
    },
    // 格式化文本-- 不需要保留状态
    formatApply: function(name, i){
      var _this = this
      var el = $(".art-area")[0],
          val = el.value,
          startPos = el.selectionStart, // 这值不能存放在data中因为它是实时变化的，也不用select事件去获得
          endPos = el.selectionEnd,
          startText = el.value.substring(0, startPos),
          endText = el.value.substring(endPos),
          selectedText = el.value.substring(startPos, endPos)

      // 应用格式函数--根据scope判断，插入的类型是包括，还是插入前面，或插入后面
      var apllyWrap = function(character, scope){
        var c_len = character.length
        // 取消加粗
        if(val.substring(startPos, startPos - c_len) == character && val.substring(endPos, endPos + c_len) == character ){
           _this.content = val.substring(0, startPos - c_len) + selectedText + val.substring(endPos + c_len)
           setTimeout(()=>{
             el.selectionStart = startPos - c_len
             el.selectionEnd = endPos - c_len
           }, 10)
        }else{
        // 加粗
           _this.content = startText + character + selectedText + character + endText
           setTimeout(()=>{
             el.selectionStart = startPos + c_len
             el.selectionEnd = endPos + c_len
           }, 10)
        }
      }
      if ('selectionStart' in el) {
         if (startPos != endPos) {
           // 插入格式符
           switch(name) {
             // 粗体
             case "bold":
                 apllyWrap("**")
               break
             // 斜体
             case "italic":
                 apllyWrap("_")
               break
           }
         }

      }
    },
    formatPrevent: function(e){
      // 点击工具栏按钮阻止默认事件，textarea不失去焦点
      e.preventDefault();
      return false;
    }
  }
})
</script>

</body>
</html>
